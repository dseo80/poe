; made by /u/lutcikaur
; THIS REQUIRES AHK Please grab the recommended version from http://ahkscript.org/
; As always, test the logout before you run into hardcore.
; If you find some errors, the list is at the bottom. Search for the error code.
; Read all of the following preferences , theyre in the settings.ini in c:\users\%profile%\documents\autohotkey

; GUI's in use : 1, 2, 3, 4, 5

#NoEnv  ; Recommended for performance and compatibility with future AutoHotkey releases.
#SingleInstance force

FileEncoding , UTF-8
SendMode Input
SetTitleMatchMode, 3

macroVersion := 120

If (A_AhkVersion <= "1.1.15")
{
	msgbox, You need AutoHotkey v1.1.15 or later to run this script. `n`nPlease go to http://ahkscript.org/download and download a recent version.
	exit
}

If !A_IsAdmin {
	Run *RunAs "%A_ScriptFullPath%"
	ExitApp
}

IfNotExist, %A_MyDocuments%\AutoHotkey\Lib
{
	FileCreateDir, %A_MyDocuments%\AutoHotKey\Lib
}
SetWorkingDir %A_MyDocuments%\AutoHotKey

IfNotExist, cports.exe
{
UrlDownloadToFile, http://lutbot.com/ahk/cports.exe, cports.exe
	if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED02 : There was a problem downloading cports.exe
UrlDownloadToFile, http://lutbot.com/ahk/cports.chm, cports.chm
	if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED03 : There was a problem downloading cports.chm 
UrlDownloadToFile, http://lutbot.com/ahk/readme.txt, readme.txt
	if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED04 : There was a problem downloading readme.txt
}

IfNotExist, settings.ini
{
	defaultIni := "[variables]`n"
	defaultIni .= "CharacterName=BTOneMonthLut`n"
	defaultIni .= "AccountName=Lutcikaur`n"
	defaultIni .= "League=standard`n"
	defaultIni .= "PoeSteam=0`n"
	defaultIni .= "UpdateTimer=1000`n"
	defaultIni .= "XOffset=0`n"
	defaultIni .= "YOffset=0`n"
	defaultIni .= "MonitorWhispers=0`n"
	defaultIni .= "MonitorWhispersDelay=10000`n"
	defaultIni .= "LogFileLocation=ERROR PLEASE SELECT LOG FILE`n"
	defaultIni .= "OverlayToggle=0`n"
	defaultIni .= "SoundSelector=*-1`n"
	defaultIni .= "[whisperMessages]`n"
	defaultIni .= "wm1=One moment, I'm in a map.`n"
	defaultIni .= "wm2=Type a sentence here`n"
	defaultIni .= "wm3=Type a sentence here`n"
	defaultIni .= "wm4=Type a sentence here`n"
	defaultIni .= "wm5=Type a sentence here`n"
	defaultIni .= "[partyMessages]`n"
	defaultIni .= "pm1=Watch for corrupting blood!`n"
	defaultIni .= "pm2=Type a sentence here`n"
	defaultIni .= "pm3=Dangerous exile!`n"
	defaultIni .= "pm4=Minion Instability / Iceblood!`n"
	defaultIni .= "pm5=Type a sentence here`n"
	defaultIni .= "[hotkeys]`n"
	defaultIni .= "logout=```n"
	defaultIni .= "superLogout=F12`n"
	defaultIni .= "oos=F2`n"
	defaultIni .= "remaining=F3`n"
	defaultIni .= "itemLevel=F4`n"
	defaultIni .= "hideout=F5`n"
	defaultIni .= "invite=F6`n"
	defaultIni .= "toggleOverlay=F9`n"
	defaultIni .= "options=F10`n"
	defaultIni .= "wm1=^1`n"
	defaultIni .= "wm2=^2`n"
	defaultIni .= "wm3=^3`n"
	defaultIni .= "wm4=^4`n"
	defaultIni .= "wm5=^5`n"
	defaultIni .= "pm1=!1`n"
	defaultIni .= "pm2=!2`n"
	defaultIni .= "pm3=!3`n"
	defaultIni .= "pm4=!4`n"
	defaultIni .= "pm5=!5"

	FileAppend, %defaultIni%, settings.ini, UTF-16
}

UrlDownloadToFile, http://lutbot.com/ahk/version.html, version.html
	if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED06 : There was a problem checking for the latest version.

FileRead, newestVersion, version.html

if ( macroVersion < newestVersion ) {
	UrlDownloadToFile, http://lutbot.com/ahk/changelog.txt, changelog.txt
			if ErrorLevel
					MsgBox, Error %ErrorLevel% at ED08 : There was a problem checking for the latest changelog.
	Gui, 4:Add, Text,, Update Available.`nYoure running version %macroVersion%. The newest is version %newestVersion%`nI either messed something up in this version, or I added something new.`nCan I download it for you? It will only take a moment, and the script will automatically restart.
	FileRead, changelog, changelog.txt
	Gui, 4:Add, Edit, w600 h200 +ReadOnly, %changelog% 
	Gui, 4:Add, Button, section default grunUpdate, Update
	Gui, 4:Add, Button, ys gdontUpdate, Skip Update
	Gui, 4:Show
}
;Get league listing
UrlDownloadToFile, http://api.exiletools.com/ladder?activeleagues=1, leagues.json
	if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED09 : Error downloading list of active leagues

FileRead, leagues, leagues.json
JSON_obj_leagues := json_toobj(leagues)
leagueString := JSON_obj_leagues[0]
while JSON_obj_leagues[a_index] != "" 
{
	leagueString .= "|" . JSON_obj_leagues[a_index]
}

; Holy fuck inefficient.. MAP LISTINGS!!!
map1 :=  "crypt"
map2 :=  "desert"
map3 :=  "dunes"
map4 :=  "dungeon"
map5 :=  "grotto"
map6 :=  "pit"
map7 :=  "tropical_island"
map8 :=  "aqueduct"
map9 :=  "arcade"
map10 :=  "cemetery"
map11 :=  "channel"
map12 :=  "mountain_ledge"
map13 :=  "sewer"
map14 :=  "thicket"
map15 :=  "wharf"
map16 :=  "ghetto"
map17 :=  "mud_geyser"
map18 :=  "museum"
map19 :=  "quarry"
map20 :=  "reef"
map21 :=  "spider_lair"
map22 :=  "vaal_pyramid"
map23 :=  "arena"
map24 :=  "overgrown_shrine"
map25 :=  "promenade"
map26 :=  "shore"
map27 :=  "spider_forest"
map28 :=  "tunnel"
map29 :=  "bog"
map30 :=  "coves"
map31 :=  "graveyard"
map32 :=  "pier"
map33 :=  "underground_sea"
map34 :=  "villa"
map35 :=  "arachnid_nest"
map36 :=  "catacomb"
map37 :=  "colonnade"
map38 :=  "dry_woods"
map39 :=  "strand"
map40 :=  "temple"
map41 :=  "jungle_valley"
map42 :=  "labyrinth"
map43 :=  "mine"
map44 :=  "torture_chamber"
map45 :=  "waste_pool"
map46 :=  "canyon"
map47 :=  "cells"
map48 :=  "dark_forest"
map49 :=  "dry_peninsula"
map50 :=  "orchard"
map51 :=  "arid_lake"
map52 :=  "gorge"
map53 :=  "residence"
map54 :=  "underground_river"
map55 :=  "abyss"
map56 :=  "bazaar"
map57 :=  "necropolis"
map58 :=  "plateau"
map59 :=  "academy"
map60 :=  "crematorium"
map61 :=  "precinct"
map62 :=  "springs"
map63 :=  "arsenal"
map64 :=  "overgrown_ruin"
map65 :=  "shipyard"
map66 :=  "village_ruin"
map67 :=  "courtyard"
map68 :=  "excavation"
map69 :=  "wasteland"
map70 :=  "waterways"
map71 :=  "maze"
map72 :=  "palace"
map73 :=  "shrine"
map74 :=  "vaal_temple"
map75 :=  "colosseum"
map76 :=  "core"
map77 :=  "volcano"

;Get TEMPEST listing
UrlDownloadToFile,http://poetempest.com/api/v0/current_tempests, tempests.json
	if ErrorLevel
			MsgBox, Error ED10 : Error downloading list of active tempests
FileRead, tmo, tempests.json
JSON_obj_tempests := json_toobj(tmo)

Loop, 76
{
	tempest%A_Index% := JSON_obj_tempests[map%A_Index%].name
}

;end TEMPEST listing

readFromFile()

current := 0
phase := 0
lastWhisperTimeRecieved := 0

;timers
updateTrackingTimer := 5000 ; 5 seconds
baseUpdateTrackingTimer := 300000 ; 5 minutes
oosTimer := 0
baseOosTimer := 1000
overlayTimer := 0
baseOverlayTimer := sleepTimer
updateTrackingTimerActive := true
oosTimerActive := false
overlayTimerActive := true
refreshTempestTimerActive := true
refreshTempestTimer := 450000
lastUpdated := 1

;Ranking Overlay
Gui, 1:+ToolWindow
Gui, 1:Font, s8
Gui, 1:Add, Text, x3 y2 vguiOos, OOS: Ready
Gui, 1:Add, Text, x3 y17, Settings:F10
Gui, 1:Font, s14
Gui, 1:Add, Text, x67 y4 w120 vguiRank, Rank: N/A
Gui, 1:Add, Text, x175 y4 w55 vguiMovedRanks, N/A
Gui, 1:Font, s7
Gui, 1:Add, Text, x3 y32, Exp Above :
Gui, 1:Add, Text, x3 y47, Exp Below :
Gui, 1:Add, Text, x66 y32 w66 vguiAbove1, N/A
Gui, 1:Add, Text, x135 y32 w66 vguiAbove2, N/A
Gui, 1:Add, Text, x66 y47 w66 vguiBelow1, N/A
Gui, 1:Add, Text, x135 y47 w66 vguiBelow2, N/A
Gui, 1:Font, s14

Gui, 1:Show, x0 y0 w225 h37, poeGUI
Gui, 1:-Caption +AlwaysOnTop +Disabled +E0x20 +LastFound
Winset,TransColor, 0xFFFFFF

;Tempest Overlay
Gui, 5:+ToolWindow
Gui, 5:Font, s8
Gui, 5:Margin, 0, 0
Gui, 5:Add, ListView, -LV0x10 -ReadOnly R39 -WantF2 w600, Map|Tempest|Map|Tempest

Gui, 5:Default
Gui, 5:ListView, LV1
drawTempests()
LV_ModifyCol()
LV_ModifyCol(1,98)
LV_ModifyCol(2,200)
LV_ModifyCol(3,98)
LV_ModifyCol(4,200)
Gui, 5:Show, x0 y0 w590 h670, tempestGUI
Gui, 5:-Caption +AlwaysOnTop +Disabled +E0x20 +LastFound
Winset,TransColor, 0xFFFFFE

;Menu
Gui, 2:Add, Text,, CharacterName:
Gui, 2:Add, Text,, AccountName:
Gui, 2:Add, Text,, Char's League :
Gui, 2:Add, Text,, Playing w/ Steam? :
Gui, 2:Add, Text,, UpdateTimer:
Gui, 2:Add, Text,, Overlay X Offset:
Gui, 2:Add, Text,h34, Overlay Y Offset:

Gui, 2:Add, Text,, Logout:
Gui, 2:Add, Text,, SuperLogout:
Gui, 2:Add, Text,, /Oos:
Gui, 2:Add, Text,, /Remaining :
Gui, 2:Add, Text,, /ItemLevel :
Gui, 2:Add, Text,, Travel to Hideout :
Gui, 2:Add, Text,, Invite Player :
Gui, 2:Add, Text,, Toggle Overlay Size:
Gui, 2:Add, Text,, Options (This GUI) :

Gui, 2:Add, Edit, vguiChar ym w100 h20, %charName%
Gui, 2:Add, Edit, vguiAcc w100 h20, %accName%
Gui, 2:Add, DropDownList, vguiLeague w100, %leagueString%
GuiControl, 2:ChooseString, guiLeague, %league%
Gui, 2:Add, Checkbox, vguiSteam w100 h20 Checked%steam%
Gui, 2:Add, Edit, vguiUpdate w100 h20, %sleepTime%
Gui, 2:Add, Edit, vguiXOffset w100 h20, %xOffset%
Gui, 2:Add, Edit, vguiYOffset w100 h20, %yOffset%

Gui, 2:Add, Text, w100 h20, Hotkey:
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyLogout , %hotkeyLogout%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeySuperLogout , %hotkeySuperLogout%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyOos , %hotkeyOos%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyRemaining , %hotkeyRemaining%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyItemLevel , %hotkeyItemLevel%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyHideout , %hotkeyHideout%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyInvite , %hotkeyInvite%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyToggleOverlay , %hotkeyToggleOverlay%
Gui, 2:Add, Hotkey, w100 h20 vguihotkeyOptions , %hotkeyOptions%

Gui, 2:Add, Text, ym, Whisper Hotkey:
Gui, 2:Add, Hotkey, vguihotkeywm1 w100 h20 , %hotkeywm1%
Gui, 2:Add, Hotkey, vguihotkeywm2 w100 h20 , %hotkeywm2%
Gui, 2:Add, Hotkey, vguihotkeywm3 w100 h20 , %hotkeywm3%
Gui, 2:Add, Hotkey, vguihotkeywm4 w100 h20 , %hotkeywm4%
Gui, 2:Add, Hotkey, vguihotkeywm5 w100 h20 , %hotkeywm5%

Gui, 2:Add, Text,, Party Hotkey:
Gui, 2:Add, Hotkey, vguihotkeypm1 w100 h20 , %hotkeypm1%
Gui, 2:Add, Hotkey, vguihotkeypm2 w100 h20 , %hotkeypm2%
Gui, 2:Add, Hotkey, vguihotkeypm3 w100 h20 , %hotkeypm3%
Gui, 2:Add, Hotkey, vguihotkeypm4 w100 h20 , %hotkeypm4%
Gui, 2:Add, Hotkey, vguihotkeypm5 w100 h20 , %hotkeypm5%
Gui, 2:Add, Text,, Questions? Comments?

Gui, 2:Add, Text, ym w200, Whisper Message Text:
Gui, 2:Add, Edit, vguiwm1 w200 h20, %wm1%
Gui, 2:Add, Edit, vguiwm2 w200 h20, %wm2%
Gui, 2:Add, Edit, vguiwm3 w200 h20, %wm3%
Gui, 2:Add, Edit, vguiwm4 w200 h20, %wm4%
Gui, 2:Add, Edit, vguiwm5 w200 h20, %wm5%

Gui, 2:Add, Text, w200, Party Message Text:
Gui, 2:Add, Edit, vguipm1 w200 h20, %pm1%
Gui, 2:Add, Edit, vguipm2 w200 h20, %pm2%
Gui, 2:Add, Edit, vguipm3 w200 h20, %pm3%
Gui, 2:Add, Edit, vguipm4 w200 h20, %pm4%
Gui, 2:Add, Edit, vguipm5 w200 h20, %pm5%
Gui, 2:Add, Text,, @Lutcikaur ingame or /u/lutcikaur on reddit

Gui, 2:Add, Text, xm section, Monitor Whispers:
Gui, 2:Add, Checkbox, ys vguiMonitorWhispers h20 Checked%monitorWhispers%
Gui, 2:Add, Text, ys, Check Delay (ms):
Gui, 2:Add, Edit, ys vguiMonitorWhispersDelay w100 h20, %monitorWhispersDelay%
Gui, 2:Add, Button, ys gchangelogGui, Changelog
Gui, 2:Add, Button, ys default gupdateHotkeys, Okay

Gui, 2:Add, Button, section xm gbrowseForLogFile , Browse for Log File
Gui, 2:Add, Text, ys, Whisper Notification Sound:
Gui, 2:Add, DropDownList, ys vguiSoundSelector w50, None|*-1|*16|*32|*48|*64
GuiControl, 2:ChooseString, guiSoundSelector, %soundSelector%
Gui, 2:Add, Button, ys gplaySound, TestPlay Sound
Gui, 2:Add, Text, w380 xs vguiLogFileLocation, %logFileLocation%

; some fucking initializers. Put these together later.
toggle--
toggleOverlay()

;start the main loop. Gotta be last
loopTimers()

superLogoutCommand(){
superLogoutCommand:
	logoutCommand()
	return
}

logoutCommand(){
logoutCommand:
	global string, lastlogout
	ltime := lastlogout + 1000
	if ( ltime < A_TickCount ) {
		Run, %string%
		lastlogout := A_TickCount
	}
	return
}

invite(){
inviteCommand:
	BlockInput On
	Send ^{Enter}{Home}{Delete}/invite {Enter}
	BlockInput Off
	return
}

oosCommand(){
oosCommand:
	global oosTimer, baseOosTimer, oosTimerActive
	BlockInput On
	SendInput, {enter}
	Sleep 2
	SendInput, {/}oos
	SendInput, {enter}
	BlockInput Off
	oosTimerActive := true
	return
}

remaining(){
remainingCommand:
	BlockInput On
	SendInput, {enter}
	Sleep 2
	SendInput, {/}remaining
	SendInput, {enter}
	BlockInput Off
	return
}

itemlevel(){
itemLevelCommand:
	BlockInput On
	SendInput, {Enter}
	Sleep 2
	SendInput, {/}itemlevel
	SendInput, {Enter}
	Sleep 75
	BlockInput Off
	return
}

hideout(){
hideoutCommand:
	BlockInput On
	SendInput, {Enter}
	Sleep 2
	SendInput, {/}hideout
	SendInput, {Enter}
	BlockInput Off
	return
}

whisperCommand1:
	BlockInput On
	Sleep 2
	SendInput ^{Enter}
	SendInput %wm1%
	SendInput {Enter}
	BlockInput Off
	return
whisperCommand2:
	BlockInput On
	Sleep 2
	SendInput ^{Enter}
	SendInput %wm2%
	SendInput {Enter}
	BlockInput Off
	return
whisperCommand3:
	BlockInput On
	Sleep 2
	SendInput ^{Enter}
	SendInput %wm3%
	SendInput {Enter}
	BlockInput Off
	return
whisperCommand4:
	BlockInput On
	Sleep 2
	SendInput ^{Enter}
	SendInput %wm4%
	SendInput {Enter}
	BlockInput Off
	return
whisperCommand5:
	BlockInput On
	Sleep 2
	SendInput ^{Enter}
	SendInput %wm5%
	SendInput {Enter}
	BlockInput Off
	return
partyCommand1:
	BlockInput On
	Sleep 2
	SendInput {Enter}
	SendInput `%
	SendInput %pm1%
	SendInput {Enter}
	BlockInput Off
	return
partyCommand2:
	BlockInput On
	Sleep 2
	SendInput {Enter}
	SendInput `%
	SendInput %pm2%
	SendInput {Enter}
	BlockInput Off
	return
partyCommand3:
	BlockInput On
	Sleep 2
	SendInput {Enter}
	SendInput `%
	SendInput %pm3%
	SendInput {Enter}
	BlockInput Off
	return
partyCommand4:
	BlockInput On
	Sleep 2
	SendInput {Enter}
	SendInput `%
	SendInput %pm4%
	SendInput {Enter}
	BlockInput Off
	return
partyCommand5:
	BlockInput On
	Sleep 2
	SendInput {Enter}
	SendInput `%
	SendInput %pm5%
	SendInput {Enter}
	BlockInput Off
	return

browseForLogFile:
	FileSelectFile, logFileLocation,, , Navigate to C:\Program Files (x86)\Grinding Gear Games\Path of Exile\logs, Text Documents (*.txt; *.log)
	GuiControl,2:, guiLogFileLocation, %logFileLocation%
	return

changelogGui(){
changelogGui:
	FileRead, changelog, changelog.txt
	Gui, 3:Add, Edit, w600 h200 +ReadOnly, %changelog% 
	Gui, 3:Show
	return
}

playSound:
	Gui, 2:Submit, nohide
	SoundPlay, %guiSoundSelector%
	return

toggleOverlay(){
toggleOverlayCommand:
	global toggle
	toggle++
	if toggle > 2
		toggle := -1
	if toggle = -1
	{
		Gui, 1:Hide
		Gui, 5:Hide
	}
	if toggle = 0
	{
		Gui, 5:Hide
		Gui, 1:Show, h60 NA
	}
	if toggle = 1
	{
		Gui, 5:Hide
		Gui, 1:Show, h31 NA
	} 
	if toggle = 2
	{
		Gui, 1:Hide
		Gui, 5:Show, NA
	}
	return
}

checkOverlay(){
	global overlayTimer, baseOverlayTimer, toggle, xOffset, yOffset
	if toggle != -1
	{
			IfWinActive Path of Exile
			{
				WinGetActiveStats,name,width,height,x,y
				width += x
				width += xOffset
				hh := y
				hh += yOffset
				if toggle = 2 
				{
					width /= 2
					width -= 295
					height /= 2
					height -= 325
					Gui, 5:Show,  y%height% x%width% NA
				} 
				if ( toggle = 1 ) || ( toggle = 0 )
				{
					width -= 231
					Gui, 1:Show,  y%hh% x%width% NA
				}
			} else {
				Gui, 1:Hide
				Gui, 5:Hide
			}
	}
	overlayTimer := baseOverlayTimer
	return
}

runUpdate(){
runUpdate:
	UrlDownloadToFile, http://lutbot.com/ahk/macro.ahk, %A_ScriptFullPath%
		if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED07 : There was a problem downloading the latest version.
		else
			Run "%A_ScriptFullPath%"
	Sleep 5000 ;This shouldn't ever hit.
dontUpdate:
	Gui, 4:Destroy
	return	
}

checkForWhispers(){
	global logFileLocation, lastWhisperTimeRecieved, monitorWhispersTimer, monitorWhispersDelay, soundSelector
	FileRead, BIGFILE, %logFileLocation%
	StringGetPos, last25Location, BIGFILE,`n, R75
	StringTrimLeft, smallfile, BIGFILE, %last25Location%

	regexLocation := 1
	arrayCount := 0
	newStart := 0

	While regexLocation
	{
		regexLocation := RegExMatch( smallfile, "(\d\d\d\d.\d\d.\d\d \d\d:\d\d:\d\d)(?:.*)\[INFO Client \d+\] \@(.*)", regexString, regexLocation+1)
		if regexLocation != 0
		{
			time%arrayCount% := regexString1
			s%arrayCount% := regexString2
			arrayCount++
		}
	}


	loopCounter := 0
	lnum := arrayCount-1
	displayStart := arrayCount
	d = :::
	while loopCounter < arrayCount
	{
		if ( time%loopCounter% > lastWhisperTimeRecieved )
		{
			displayStart := loopCounter
			goto breakWhisperTimes
		}
		loopCounter++
	}
	breakWhisperTimes:
	if( lnum < 0)
		lnum := 0
	lastWhisperTimeRecieved := time%lnum%
	displayString := ""
	iterations := arrayCount - displayStart
	loopCounter := arrayCount

	while loopCounter > displayStart
	{
		loopCounter--
		displayString .= s%loopCounter% . "`n"
	}

	IfWinNotActive Path of Exile
		if iterations > 0
		{
			TrayTip, New Messages: `(%iterations%`), %displayString%
			SoundPlay, %soundSelector%
		}
	monitorWhispersTimer := monitorWhispersDelay
	return
}

updateOos(){
	global oosTimer, baseOosTimer, oosTimerActive
	static base = 10
	if (base > 0) {
		oos := "OOS: " . base-- . ""
		oosTimer := baseOosTimer
	}       
	else
	{
		oos := "OOS: Ready"
		oosTimerActive := false
		base := 10
	}
			
	GuiControl,1:, guiOos, %oos%
	return
}

loopTimers(){
	global
	Loop {
		if ( overlayTimerActive = true ) 
			overlayTimer -= sleepTime    
		if ( oosTimerActive = true )
			oosTimer -= sleepTime
		if ( updateTrackingTimerActive = true )
			updateTrackingTimer -= sleepTime
		if ( monitorWhispers )
			monitorWhispersTimer -= sleepTime
		if ( refreshTempestTimerActive )
			refreshTempestTimer -= sleepTime

		if ( overlayTimer <= 0 ) && ( overlayTimerActive = true )
		{
			checkOverlay()
		}
				
		if ( oosTimer <= 0 ) && ( oosTimerActive = true )
		{
			updateOos()
		}
				
		if ( updateTrackingTimer <= 0 ) && ( updateTrackingTimerActive = true )
		{
			IfWinExist, Path of Exile
				updateTracking()
			else
				updateTrackingTimer := 60000
		}

		if ( refreshTempestTimer <= 0 ) && ( refreshTempestTimerActive = true ) 
		{
			IfWinExist, Path of Exile
				refreshTempests()
			else
				refreshTempestTimer := 60000
		}

		if ( monitorWhispersTimer <= 0 ) && ( monitorWhispers )
		{
			IfWinExist, Path of Exile
				checkForWhispers()
		}
		Sleep sleepTime  
	}
	return
}

drawTempests(){
	global
	Loop, 39
	{
		i := A_Index + 39
		m := map%i%
		t := tempest%i%
		LV_Add("", map%A_Index%, tempest%A_Index%,m,t)
	}
return
}


refreshTempests(){
	global

	UrlDownloadToFile,http://poetempest.com/api/v0/current_tempests, tempests.json
	if ErrorLevel
			MsgBox, Error %ErrorLevel% at ED10 : Error downloading list of active tempests

	FileRead, tmo, tempests.json
	JSON_obj_tempests := json_toobj(tmo)

	Gui, 5:Default
	Gui, 5:ListView, LV1
	Loop, 39
	{
		i := A_Index + 39
		LV_Modify(A_Index,"Col2", JSON_obj_tempests[map%A_Index%].name)
		LV_Modify(A_Index,"Col4", JSON_obj_tempests[map%i%].name)
	}
	
	refreshTempestTimer := 900000
}

updateTracking(){
	global charName, accName, league, updateTrackingTimer, baseUpdateTrackingTimer, lastUpdated

	url := "http://poe.pwx.me/api/ladder?league=" . league . "&char=" . charName . ""

	UrlDownloadToFile, %url%, ladder.json
		if ErrorLevel
			GuiControl,1:, rank, "Rank: Error %ErrorLevel% at ED01"

	FileRead, ladderString, ladder.json
	JSON_obj := json_toobj(ladderString)

	combined := accName . "." . charName
	updated := JSON_obj[combined].updated
	if ( updated = lastUpdated )
	{
		updateTrackingTimer := 60000 ; Wait one minute to check again
		return
	}
	lastUpdated := updated
	rank := JSON_obj[combined].rank
	if ( !rank ) {
		rank := "Min Lv:"
		url := "http://poe.pwx.me/api/ladder?league=" . league . "&status=1"
		UrlDownloadToFile, %url%, league.json
			if ErrorLevel
				GuiControl,1:, rank, "Rank: Error %ErrorLevel% at ED05"
		FileRead, leagueString, league.json
		leagueObj := json_toobj(leagueString)
		movedRanks := leagueObj[league].toGetOnLadder.level
		above1 = N/A
		above2 = N/A
		below1 = N/A
		below2 = N/A
	} else {
		movedRanks := JSON_obj[combined].movedRanks
		above1 := JSON_obj[combined].xp_to_rank_above[rank-1]
		above1 := RegExReplace(above1, "(\d)(?=(?:\d{3})+(?:\.|$))", "$1,")
		above2 := JSON_obj[combined].xp_to_rank_above[rank-2]
		above2 := RegExReplace(above2, "(\d)(?=(?:\d{3})+(?:\.|$))", "$1,")
		below1 := JSON_obj[combined].xp_to_rank_below[rank+1]
		below1 := RegExReplace(below1, "(\d)(?=(?:\d{3})+(?:\.|$))", "$1,")
		below2 := JSON_obj[combined].xp_to_rank_below[rank+2]
		below2 := RegExReplace(below2, "(\d)(?=(?:\d{3})+(?:\.|$))", "$1,")
		rank := "Rank: " . rank
		if ( movedRanks < 0 ) {
			Gui, 1:Font, cRed
			GuiControl, 1:Font, guiMovedRanks
		}
		if ( movedRanks > 0 ) {
			Gui, 1:Font, cGreen
			GuiControl, 1:Font, guiMovedRanks
		}
	}

	GuiControl,1:,guiAbove1, %above1%
	GuiControl,1:,guiAbove2, %above2%
	GuiControl,1:,guiBelow1, %below1%
	GuiControl,1:,guiBelow2, %below2%

	GuiControl,1:, guiRank, %rank%
	GuiControl,1:, guiMovedRanks, %movedRanks%

	updateTrackingTimer := baseUpdateTrackingTimer ; Wait the base time

	return
}

hotkeys(){
optionsCommand:
	global
	Gui, 2:Show,, Macro Settings Version %macroVersion% :: AHK Version %A_AhkVersion%
	return
}

submit(){  
updateHotkeys:
	global
	Gui, 2:Submit 
	updsettings := "[variables]`n"
	updsettings .= "CharacterName=" . guiChar . "`n"
	updsettings .= "AccountName=" . guiAcc . "`n"
	updsettings .= "League=" . guiLeague . "`n"
	updsettings .= "PoeSteam=" . guiSteam . "`n"
	updsettings .= "UpdateTimer=" . guiUpdate . "`n"
	updsettings .= "XOffset=" . guiXOffset . "`n"
	updsettings .= "YOffset=" . guiYOffset . "`n"
	updsettings .= "MonitorWhispers=" . guiMonitorWhispers . "`n"
	updsettings .= "MonitorWhispersDelay=" . guiMonitorWhispersDelay . "`n"
	updsettings .= "LogFileLocation=" . logFileLocation . "`n"
	updsettings .= "OverlayToggle=" . toggle . "`n"
	updsettings .= "SoundSelector=" . guiSoundSelector . "`n"
	updsettings .= "[whisperMessages]`n"
	updsettings .= "wm1=" . guiwm1 . "`n"
	updsettings .= "wm2=" . guiwm2 . "`n"
	updsettings .= "wm3=" . guiwm3 . "`n"
	updsettings .= "wm4=" . guiwm4 . "`n"
	updsettings .= "wm5=" . guiwm5 . "`n"
	updsettings .= "[partyMessages]`n"
	updsettings .= "pm1=" . guipm1 . "`n"
	updsettings .= "pm2=" . guipm2 . "`n"
	updsettings .= "pm3=" . guipm3 . "`n"
	updsettings .= "pm4=" . guipm4 . "`n"
	updsettings .= "pm5=" . guipm5 . "`n"
	updsettings .= "[hotkeys]`n"
	updsettings .= "logout=" . guihotkeyLogout . "`n"
	updsettings .= "superLogout=" . guihotkeySuperLogout . "`n"
	updsettings .= "oos=" . guihotkeyOos . "`n"
	updsettings .= "remaining=" . guihotkeyRemaining . "`n"
	updsettings .= "itemLevel=" . guihotkeyItemLevel . "`n"
	updsettings .= "hideout=" . guihotkeyHideout . "`n"
	updsettings .= "invite=" . guihotkeyInvite . "`n"
	updsettings .= "toggleOverlay=" . guihotkeyToggleOverlay . "`n"
	updsettings .= "options=" . guihotkeyOptions . "`n"
	updsettings .= "wm1=" . guihotkeywm1 . "`n"
	updsettings .= "wm2=" . guihotkeywm2 . "`n"
	updsettings .= "wm3=" . guihotkeywm3 . "`n"
	updsettings .= "wm4=" . guihotkeywm4 . "`n"
	updsettings .= "wm5=" . guihotkeywm5 . "`n"
	updsettings .= "pm1=" . guihotkeypm1 . "`n"
	updsettings .= "pm2=" . guihotkeypm2 . "`n"
	updsettings .= "pm3=" . guihotkeypm3 . "`n"
	updsettings .= "pm4=" . guihotkeypm4 . "`n"
	updsettings .= "pm5=" . guihotkeypm5

	FileDelete settings.ini
	FileAppend, %updsettings%, settings.ini, UTF-16

	readFromFile()

	return    
}

updateFiles(){
	
}

readFromFile(){
	global
	;reset hotkeys ughh.
	Hotkey, IfWinActive, Path of Exile
	If hotkeyLogout
		Hotkey,% hotkeyLogout, logoutCommand, Off
	If hotkeyOos
		Hotkey,% hotkeyOos, oosCommand, Off
	If hotkeyRemaining
		Hotkey,% hotkeyRemaining, remainingCommand, Off
	If hotkeyItemLevel
		Hotkey,% hotkeyItemLevel, itemLevelCommand, Off
	If hotkeyHideout
		Hotkey,% hotkeyHideout, hideoutCommand, Off
	If hotkeyInvite
		Hotkey,% hotkeyInvite, inviteCommand, Off
	If hotkeyToggleOverlay
		Hotkey,% hotkeyToggleOverlay, toggleOverlayCommand, Off
	If hotkeywm1
		Hotkey,% hotkeywm1, whisperCommand1, Off
	If hotkeywm2
		Hotkey,% hotkeywm2, whisperCommand1, Off
	If hotkeywm3
		Hotkey,% hotkeywm3, whisperCommand1, Off
	If hotkeywm4
		Hotkey,% hotkeywm4, whisperCommand1, Off
	If hotkeywm5
		Hotkey,% hotkeywm5, whisperCommand1, Off
	If hotkeypm1
		Hotkey,% hotkeypm1, partyCommand1, Off
	If hotkeypm2
		Hotkey,% hotkeypm2, partyCommand2, Off
	If hotkeypm3
		Hotkey,% hotkeypm3, partyCommand3, Off
	If hotkeypm4
		Hotkey,% hotkeypm4, partyCommand4, Off
	If hotkeypm5
		Hotkey,% hotkeypm5, partyCommand5, Off

	Hotkey, IfWinActive
	If hotkeyOptions
		Hotkey,% hotkeyOptions, optionsCommand, Off
	If hotkeySuperLogout
		Hotkey,% hotkeySuperLogout, superLogoutCommand, Off
	Hotkey, IfWinActive, Path of Exile

	; variables
	IniRead, charName, settings.ini, variables, CharacterName
	IniRead, accName, settings.ini, variables, AccountName
	IniRead, league, settings.ini, variables, League
	IniRead, steam, settings.ini, variables, PoeSteam
	IniRead, sleepTime, settings.ini, variables, UpdateTimer
	IniRead, xOffset, settings.ini, variables, XOffset
	IniRead, yOffset, settings.ini, variables, YOffset
	IniRead, monitorWhispers, settings.ini, variables, MonitorWhispers
	IniRead, monitorWhispersDelay, settings.ini, variables, MonitorWhispersDelay
	IniRead, logFileLocation, settings.ini, variables, LogFileLocation
	IniRead, toggle, settings.ini, variables, OverlayToggle
	IniRead, soundSelector, settings.ini, variables, SoundSelector
	; whisper messages
	IniRead, wm1, settings.ini, whisperMessages, wm1
	IniRead, wm2, settings.ini, whisperMessages, wm2
	IniRead, wm3, settings.ini, whisperMessages, wm3
	IniRead, wm4, settings.ini, whisperMessages, wm4
	IniRead, wm5, settings.ini, whisperMessages, wm5
	;party messages
	IniRead, pm1, settings.ini, partyMessages, pm1
	IniRead, pm2, settings.ini, partyMessages, pm2
	IniRead, pm3, settings.ini, partyMessages, pm3
	IniRead, pm4, settings.ini, partyMessages, pm4
	IniRead, pm5, settings.ini, partyMessages, pm5
	;hotkeys
	IniRead, hotkeyLogout, settings.ini, hotkeys, logout, %A_Space%
	IniRead, hotkeySuperLogout, settings.ini, hotkeys, superLogout, %A_Space%
	IniRead, hotkeyOos, settings.ini, hotkeys, oos, %A_Space%
	IniRead, hotkeyRemaining, settings.ini, hotkeys, remaining, %A_Space%
	IniRead, hotkeyItemLevel, settings.ini, hotkeys, itemLevel, %A_Space%
	IniRead, hotkeyHideout, settings.ini, hotkeys, hideout, %A_Space%
	IniRead, hotkeyInvite, settings.ini, hotkeys, invite, %A_Space%
	IniRead, hotkeyToggleOverlay, settings.ini, hotkeys, toggleOverlay, %A_Space%
	IniRead, hotkeyOptions, settings.ini, hotkeys, options, %A_Space%
	IniRead, hotkeywm1, settings.ini, hotkeys, wm1, %A_Space%
	IniRead, hotkeywm2, settings.ini, hotkeys, wm2, %A_Space%
	IniRead, hotkeywm3, settings.ini, hotkeys, wm3, %A_Space%
	IniRead, hotkeywm4, settings.ini, hotkeys, wm4, %A_Space%
	IniRead, hotkeywm5, settings.ini, hotkeys, wm5, %A_Space%
	IniRead, hotkeypm1, settings.ini, hotkeys, pm1, %A_Space%
	IniRead, hotkeypm2, settings.ini, hotkeys, pm2, %A_Space%
	IniRead, hotkeypm3, settings.ini, hotkeys, pm3, %A_Space%
	IniRead, hotkeypm4, settings.ini, hotkeys, pm4, %A_Space%
	IniRead, hotkeypm5, settings.ini, hotkeys, pm5, %A_Space%

	Hotkey, IfWinActive, Path of Exile
	If hotkeyLogout
		Hotkey,% hotkeyLogout, logoutCommand, On
	If hotkeyOos
		Hotkey,% hotkeyOos, oosCommand, On
	If hotkeyRemaining
		Hotkey,% hotkeyRemaining, remainingCommand, On
	If hotkeyItemLevel
		Hotkey,% hotkeyItemLevel, itemLevelCommand, On
	If hotkeyHideout
		Hotkey,% hotkeyHideout, hideoutCommand, On
	If hotkeyInvite
		Hotkey,% hotkeyInvite, inviteCommand, On
	If hotkeyToggleOverlay
		Hotkey,% hotkeyToggleOverlay, toggleOverlayCommand, On
	If hotkeywm1
		Hotkey,% hotkeywm1, whisperCommand1, On
	If hotkeywm2
		Hotkey,% hotkeywm2, whisperCommand2, On
	If hotkeywm3
		Hotkey,% hotkeywm3, whisperCommand3, On
	If hotkeywm4
		Hotkey,% hotkeywm4, whisperCommand4, On
	If hotkeywm5
		Hotkey,% hotkeywm5, whisperCommand5, On
	If hotkeypm1
		Hotkey,% hotkeypm1, partyCommand1, On
	If hotkeypm2
		Hotkey,% hotkeypm2, partyCommand2, On
	If hotkeypm3
		Hotkey,% hotkeypm3, partyCommand3, On
	If hotkeypm4
		Hotkey,% hotkeypm4, partyCommand4, On
	If hotkeypm5
		Hotkey,% hotkeypm5, partyCommand5, On


	Hotkey, IfWinActive
	If hotkeyOptions
		Hotkey,% hotkeyOptions, optionsCommand, On
	else {
		Hotkey,F10, optionsCommand, On
		msgbox You dont have some hotkeys set!`nPlease hit F10 to open up your config prompt and please configure your hotkeys (Path of Exile has to be in focus).`nThe way you configure hotkeys is now in the GUI (default F10). Otherwise, you didn't put a hotkey for the options menu. You need that silly.
	}
	If hotkeySuperLogout
		Hotkey,% hotkeySuperLogout, superLogoutCommand, On
	Hotkey, IfWinActive, Path of Exile

	; extra checks

	if monitorWhispers = ERROR
		monitorWhispers := 0
	if monitorWhispersDelay = ERROR
		monitorWhispersDelay := 10000
	if monitorWhispersDelay < 10000
		monitorWhispersDelay := 10000

	string :=""
	if ( steam ) {
		string:= "cports.exe /close * * * * PathOfExileSteam.exe"
	} else {
		string:= "cports.exe /close * * * * PathOfExile.exe"
	}

	updateTrackingTimer := 5000
	monitorWhispersTimer := monitorWhispersDelay
}

; ; ERROR LIST
; min lv = null : you typed in the league name wrong.
; ED01 : Error downloading rank from http://poe.pwx.me/ , their server might be unavailible.
; ED02 -> ED04 : Error downloading currports from my website. http://www.nirsoft.net/utils/cports.html holds the original file.
; ED05 : Error downloading ladder stats from http://poe.pwx.me/ , their server might be unavailible.
; ED06 : Error checking for new version.
; ED07 : Error downloading newest version of ahk script.
; ED08 : Error downloading newest changelog.
; ED09 : Error downloading list of active leagues
; ED10 : Error downloading list of active tempests
; ED11 : Error downloading tempest : map%A_Index%
; ED12 : Error downloading all tempests

; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; JSON -> AHK Obj parser by VxE ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; Copyright © 2013 VxE. All rights reserved.

; Uses a two-pass iterative approach to deserialize a json string
json_toobj( str ) {

		quot := """" ; firmcoded specifically for readability. Hardcode for (minor) performance gain
		ws := "`t`n`r " Chr(160) ; whitespace plus NBSP. This gets trimmed from the markup
		obj := {} ; dummy object
		objs := [] ; stack
		keys := [] ; stack
		isarrays := [] ; stack
		literals := [] ; queue
		y := nest := 0

; First pass swaps out literal strings so we can parse the markup easily
		StringGetPos, z, str, %quot% ; initial seek
		while !ErrorLevel
		{
				; Look for the non-literal quote that ends this string. Encode literal backslashes as '\u005C' because the
				; '\u..' entities are decoded last and that prevents literal backslashes from borking normal characters
				StringGetPos, x, str, %quot%,, % z + 1
				while !ErrorLevel
				{
						StringMid, key, str, z + 2, x - z - 1
						StringReplace, key, key, \\, \u005C, A
						If SubStr( key, 0 ) != "\"
								Break
						StringGetPos, x, str, %quot%,, % x + 1
				}
		;       StringReplace, str, str, %quot%%t%%quot%, %quot% ; this might corrupt the string
				str := ( z ? SubStr( str, 1, z ) : "" ) quot SubStr( str, x + 2 ) ; this won't

		; Decode entities
				StringReplace, key, key, \%quot%, %quot%, A
				StringReplace, key, key, \b, % Chr(08), A
				StringReplace, key, key, \t, % A_Tab, A
				StringReplace, key, key, \n, `n, A
				StringReplace, key, key, \f, % Chr(12), A
				StringReplace, key, key, \r, `r, A
				StringReplace, key, key, \/, /, A
				while y := InStr( key, "\u", 0, y + 1 )
						if ( A_IsUnicode || Abs( "0x" SubStr( key, y + 2, 4 ) ) < 0x100 )
								key := ( y = 1 ? "" : SubStr( key, 1, y - 1 ) ) Chr( "0x" SubStr( key, y + 2, 4 ) ) SubStr( key, y + 6 )

				literals.insert(key)

				StringGetPos, z, str, %quot%,, % z + 1 ; seek
		}

; Second pass parses the markup and builds the object iteratively, swapping placeholders as they are encountered
		key := isarray := 1

		; The outer loop splits the blob into paths at markers where nest level decreases
		Loop Parse, str, % "]}"
		{
				StringReplace, str, A_LoopField, [, [], A ; mark any array open-brackets

				; This inner loop splits the path into segments at markers that signal nest level increases
				Loop Parse, str, % "[{"
				{
						; The first segment might contain members that belong to the previous object
						; Otherwise, push the previous object and key to their stacks and start a new object
						if ( A_Index != 1 )
						{
								objs.insert( obj )
								isarrays.insert( isarray )
								keys.insert( key )
								obj := {}
								isarray := key := Asc( A_LoopField ) = 93
						}

						; arrrrays are made by pirates and they have index keys
						if ( isarray )
						{
								Loop Parse, A_LoopField, `,, % ws "]"
										if ( A_LoopField != "" )
												obj[key++] := A_LoopField = quot ? literals.remove(1) : A_LoopField
						}
						; otherwise, parse the segment as key/value pairs
						else
						{
								Loop Parse, A_LoopField, `,
										Loop Parse, A_LoopField, :, % ws
												if ( A_Index = 1 )
														key := A_LoopField = quot ? literals.remove(1) : A_LoopField
												else if ( A_Index = 2 && A_LoopField != "" )
														obj[key] := A_LoopField = quot ? literals.remove(1) : A_LoopField
						}
						nest += A_Index > 1
				} ; Loop Parse, str, % "[{"

				If !--nest
						Break

				; Insert the newly closed object into the one on top of the stack, then pop the stack
				pbj := obj
				obj := objs.remove()
				obj[key := keys.remove()] := pbj
				If ( isarray := isarrays.remove() )
						key++

		} ; Loop Parse, str, % "]}"

		Return obj
} ; json_toobj( str )
